<?php
require_once 'db.php';

function respond($arr) {
    header('Content-Type: application/json');
    echo json_encode($arr);
    exit;
}

$conn = db_connect();

$input = json_decode(file_get_contents('php://input'), true);
if (!$input) $input = $_POST;

$token = isset($input['token']) ? $input['token'] : (isset($input['student_id']) ? $input['student_id'] : '');

if (!$token) {
    // If called via GET (user opened QR link), show simple UI
    if (isset($_GET['token'])) {
        $token = $_GET['token'];
        $stmt = $conn->prepare('SELECT id, student_id, name FROM students WHERE qr_token = ? LIMIT 1');
        $stmt->bind_param('s', $token);
        $stmt->execute();
        $res = $stmt->get_result();
        if ($res->num_rows === 0) { echo 'Student not found'; exit; }
        $row = $res->fetch_assoc();
        ?>
        <!doctype html><html><head><meta charset="utf-8"><title>QR Scan</title></head><body>
        <div style="width:600px;margin:40px auto;font-family:Arial,sans-serif;">
          <h2>Scanned: <?php echo htmlspecialchars($row['name']); ?></h2>
          <p>Student ID: <?php echo htmlspecialchars($row['student_id']); ?></p>
          <form method="post">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars($token); ?>">
            <button type="submit">Mark Attendance</button>
          </form>
        </div>
        </body></html>
        <?php
        exit;
    }
    respond(['status'=>'error','msg'=>'no token or student_id provided']);
}

// try find by token
$stmt = $conn->prepare('SELECT id, student_id, name, course, block FROM students WHERE qr_token = ? LIMIT 1');
$stmt->bind_param('s', $token);
$stmt->execute();
$res = $stmt->get_result();

if ($res->num_rows === 0) {
    // try student_id
    $stmt2 = $conn->prepare('SELECT id, student_id, name, course, block FROM students WHERE student_id = ? LIMIT 1');
    $stmt2->bind_param('s', $token);
    $stmt2->execute();
    $res2 = $stmt2->get_result();
    if ($res2->num_rows === 0) respond(['status'=>'error','msg'=>'student not found']);
    $row = $res2->fetch_assoc();
} else {
    $row = $res->fetch_assoc();
}

// insert attendance
$ins = $conn->prepare('INSERT INTO attendance (student_id, course, block, mode) VALUES (?, ?, ?, "scan")');
$ins->bind_param('iss', $row['id'], $row['course'], $row['block']);
if ($ins->execute()) {
    respond(['status'=>'ok','student'=>$row['name'],'student_id'=>$row['student_id'],'timestamp'=>date('c')]);
} else {
    respond(['status'=>'error','msg'=>$ins->error]);
}
