<?php
session_start();
require_once 'db.php';
require_once 'config.php';

if (!isset($_SESSION['user_type']) || $_SESSION['user_type'] !== 'admin') {
    header('Location: index.php'); exit;
}

$msg = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name = trim($_POST['name']);
    $student_id = trim($_POST['student_id']);
    $course = trim($_POST['course']);
    $block = trim($_POST['block']);

    if ($name === '' || $student_id === '') $msg = 'Name and Student ID required.';
    else {
        $conn = db_connect();
        $stmt = $conn->prepare('SELECT id FROM students WHERE student_id = ? LIMIT 1');
        $stmt->bind_param('s', $student_id);
        $stmt->execute();
        $stmt->store_result();
        if ($stmt->num_rows > 0) {
            $msg = 'Student ID already exists.';
        } else {
            $pw_hash = password_hash($student_id, PASSWORD_DEFAULT); // default pw = student_id
            $token = bin2hex(random_bytes(16));
            $stmt2 = $conn->prepare('INSERT INTO students (student_id, name, password_hash, course, block, qr_token, must_change_password) VALUES (?, ?, ?, ?, ?, ?, 1)');
            $stmt2->bind_param('ssssss', $student_id, $name, $pw_hash, $course, $block, $token);
            if ($stmt2->execute()) $msg = 'Student registered. QR token created.';
            else $msg = 'Error: ' . $stmt2->error;
        }
    }
}
?>
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Register Student - <?php echo SITE_NAME;?></title>
<link rel="stylesheet" href="assets/css/style.css"></head>
<body>
<div class="container">
<h1>Register Student</h1>
<?php if ($msg) echo '<div class="alert">'.htmlspecialchars($msg).'</div>'; ?>
<form method="post">
<label>Full name</label><br><input name="name" required><br>
<label>Student ID (username & default password)</label><br><input name="student_id" required><br>
<label>Course</label><br><input name="course"><br>
<label>Block</label><br><input name="block"><br><br>
<button type="submit">Register & Generate QR</button>
</form>
<p><a href="admin_dashboard.php">Back to dashboard</a></p>
</div>
</body>
</html>
