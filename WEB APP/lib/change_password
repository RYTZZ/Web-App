<?php
session_start();
require_once 'db.php';
if (!isset($_SESSION['user_type'])) { header('Location: index.php'); exit; }
$conn = db_connect();
$msg = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $current = $_POST['current_password'] ?? '';
    $new = $_POST['new_password'] ?? '';
    $confirm = $_POST['confirm_password'] ?? '';
    if ($new === '' || $new !== $confirm) $msg = 'New passwords do not match or are empty.';
    else {
        if ($_SESSION['user_type'] === 'student') {
            $uid = intval($_SESSION['user_id']);
            $stmt = $conn->prepare('SELECT password_hash FROM students WHERE id = ? LIMIT 1');
            $stmt->bind_param('i', $uid); $stmt->execute();
            $h = $stmt->get_result()->fetch_assoc()['password_hash'];
            if (!password_verify($current, $h)) $msg = 'Current password incorrect.';
            else {
                $nh = password_hash($new, PASSWORD_DEFAULT);
                $u = $conn->prepare('UPDATE students SET password_hash = ?, must_change_password = 0 WHERE id = ?');
                $u->bind_param('si', $nh, $uid); $u->execute();
                $msg = 'Password updated. <a href="student_profile.php">Go to profile</a>';
            }
        } else if ($_SESSION['user_type'] === 'admin') {
            $uid = intval($_SESSION['user_id']);
            $stmt = $conn->prepare('SELECT password_hash FROM admins WHERE id = ? LIMIT 1');
            $stmt->bind_param('i', $uid); $stmt->execute();
            $h = $stmt->get_result()->fetch_assoc()['password_hash'];
            if (!password_verify($current, $h)) $msg = 'Current password incorrect.';
            else {
                $nh = password_hash($new, PASSWORD_DEFAULT);
                $u = $conn->prepare('UPDATE admins SET password_hash = ? WHERE id = ?');
                $u->bind_param('si', $nh, $uid); $u->execute();
                $msg = 'Admin password updated. <a href="admin_dashboard.php">Go to dashboard</a>';
            }
        }
    }
}
?>
<!doctype html><html><head><meta charset="utf-8"><title>Change Password</title>
<link rel="stylesheet" href="assets/css/style.css"></head><body>
<div class="container">
<h1>Change Password</h1>
<?php if ($msg) echo '<div class="alert">'.$msg.'</div>'; ?>
<form method="post">
<label>Current password</label><br><input name="current_password" type="password" required><br>
<label>New password</label><br><input name="new_password" type="password" required minlength="6"><br>
<label>Confirm new password</label><br><input name="confirm_password" type="password" required><br><br>
<button type="submit">Update password</button>
</form>
</div></body></html>
